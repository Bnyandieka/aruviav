# M-Pesa Payment Integration - Architecture & Data Flow

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BROWSER (React)                          â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Checkout Page (CheckoutPage.jsx)               â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  1. User fills form (phone, amount)                      â”‚   â”‚
â”‚  â”‚  2. Selects M-Pesa payment method                        â”‚   â”‚
â”‚  â”‚  3. Clicks "Place Order"                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     mpesaService.js (src/services/payment)              â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  initiateMpesaPayment() {                                â”‚   â”‚
â”‚  â”‚    axios.post('http://localhost:3001/...')              â”‚   â”‚
â”‚  â”‚    payload: {                                            â”‚   â”‚
â”‚  â”‚      phone, amount, orderId                              â”‚   â”‚
â”‚  â”‚    }                                                      â”‚   â”‚
â”‚  â”‚  }                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                      â”‚
â”‚           Network        â”‚ POST /api/lipana/initiate-stk-push   â”‚
â”‚           Request        â”‚ {"phone": "...", "amount": "..."}    â”‚
â”‚                           â†“                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP
                             â”‚
                             â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    BACKEND (Express.js)            â”‚
            â”‚    localhost:3001                  â”‚
            â”‚                                    â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
            â”‚  â”‚  Startup (app.listen)        â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  console.log(               â”‚ â”‚
            â”‚  â”‚    'âœ… BACKEND RUNNING'     â”‚ â”‚
            â”‚  â”‚    'Lipana: âœ… Configured'  â”‚ â”‚
            â”‚  â”‚  )                          â”‚ â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚                                    â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
            â”‚  â”‚  POST /api/lipana/...        â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  1. Receive request          â”‚ â”‚
            â”‚  â”‚     âœ… LIPANA REQUEST       â”‚ â”‚
            â”‚  â”‚     ğŸ“± Phone: ...            â”‚ â”‚
            â”‚  â”‚     ğŸ’° Amount: ...           â”‚ â”‚
            â”‚  â”‚     ğŸ“¦ Order ID: ...         â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  2. Validate data            â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  3. Format phone number      â”‚ â”‚
            â”‚  â”‚     07xx â†’ +254xx            â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  4. Call Lipana API          â”‚ â”‚
            â”‚  â”‚     ğŸ“¤ Calling Lipana...     â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  5. Parse response           â”‚ â”‚
            â”‚  â”‚     ğŸ“¥ Response status: 200  â”‚ â”‚
            â”‚  â”‚     ğŸ“‹ Response data: {...}  â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â”‚  6. Return to frontend       â”‚ â”‚
            â”‚  â”‚     âœ… STK Push successful!  â”‚ â”‚
            â”‚  â”‚                              â”‚ â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚                                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                  HTTP       â”‚ Response JSON
                Response     â”‚ {success: true, ...}
                             â”‚
                             â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Lipana API (External)            â”‚
            â”‚   https://api.lipana.dev/v1        â”‚
            â”‚                                    â”‚
            â”‚  POST /transactions/push-stk       â”‚
            â”‚                                    â”‚
            â”‚  â† Request with:                   â”‚
            â”‚    - phone: +254712345678         â”‚
            â”‚    - amount: 100                   â”‚
            â”‚    - x-api-key: [secret]          â”‚
            â”‚                                    â”‚
            â”‚  â†’ Response with:                  â”‚
            â”‚    - transactionId: "..."         â”‚
            â”‚    - checkoutRequestID: "..."     â”‚
            â”‚    - message: "..."               â”‚
            â”‚                                    â”‚
            â”‚  (User receives STK prompt)        â”‚
            â”‚                                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Request/Response Flow with Logging

```
REQUEST JOURNEY:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚  Frontend                     Backend                         â”‚
â”‚  â”œâ”€ User clicks              â”œâ”€ [STARTUP]                    â”‚
â”‚  â”‚  "Place Order"            â”‚  console.log('âœ… RUNNING')    â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”œâ”€ Creates payload:         â”‚                               â”‚
â”‚  â”‚  {                        â”‚                               â”‚
â”‚  â”‚    phone: '0712345678'    â”‚                               â”‚
â”‚  â”‚    amount: '100'          â”‚                               â”‚
â”‚  â”‚    orderId: 'order-123'   â”‚                               â”‚
â”‚  â”‚  }                        â”‚                               â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”œâ”€ POST to                  â”‚                               â”‚
â”‚  â”‚  localhost:3001/api/...   â”‚  â† Receives request           â”‚
â”‚  â”‚                           â”‚    console.log(               â”‚
â”‚  â”‚                           â”‚      'âœ… REQUEST RECEIVED'    â”‚
â”‚  â”‚                           â”‚      'ğŸ“± Phone: ...'          â”‚
â”‚  â”‚                           â”‚      'ğŸ’° Amount: ...'         â”‚
â”‚  â”‚                           â”‚      'ğŸ“¦ Order ID: ...'       â”‚
â”‚  â”‚                           â”‚    )                          â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚  â† Validates data            â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚  â† Formats phone:            â”‚
â”‚  â”‚                           â”‚    0712345678 â†’             â”‚
â”‚  â”‚                           â”‚    +254712345678            â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚  â† Calls Lipana API          â”‚
â”‚  â”‚                           â”‚    console.log(               â”‚
â”‚  â”‚                           â”‚      'ğŸ“¤ Calling Lipana'      â”‚
â”‚  â”‚                           â”‚    )                          â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”œâ”€â†’ Lipana API                 â”‚
â”‚  â”‚                           â”‚   https://api.lipana.dev     â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚   Payload:                    â”‚
â”‚  â”‚                           â”‚   {                           â”‚
â”‚  â”‚                           â”‚     phone: '+254712345678'    â”‚
â”‚  â”‚                           â”‚     amount: 100               â”‚
â”‚  â”‚                           â”‚   }                           â”‚
â”‚  â”‚                           â”‚   Header:                     â”‚
â”‚  â”‚                           â”‚   x-api-key: [secret]         â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚â† Lipana responds with:       â”‚
â”‚  â”‚                           â”‚  {                            â”‚
â”‚  â”‚                           â”‚    success: true              â”‚
â”‚  â”‚                           â”‚    data: {                    â”‚
â”‚  â”‚                           â”‚      transactionId: "..."     â”‚
â”‚  â”‚                           â”‚      checkoutRequestID: "..." â”‚
â”‚  â”‚                           â”‚      message: "..."           â”‚
â”‚  â”‚                           â”‚    }                          â”‚
â”‚  â”‚                           â”‚  }                            â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â”‚                           â”‚  â† Processes response         â”‚
â”‚  â”‚                           â”‚    console.log(               â”‚
â”‚  â”‚                           â”‚      'ğŸ“¥ Response status: 200'â”‚
â”‚  â”‚                           â”‚      'ğŸ“‹ Response data: {...}'â”‚
â”‚  â”‚                           â”‚      'âœ… STK successful!'     â”‚
â”‚  â”‚                           â”‚    )                          â”‚
â”‚  â”‚                           â”‚                               â”‚
â”‚  â† Sends back JSON â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†â”€ Sends response to frontend â”‚
â”‚    {                                                          â”‚
â”‚      success: true,                                          â”‚
â”‚      transactionId: '...'                                    â”‚
â”‚    }                                                          â”‚
â”‚                                                               â”‚
â”‚  â”œâ”€ Checks response                                          â”‚
â”‚  â”‚  if (success) {                                           â”‚
â”‚  â”‚    show success toast                                     â”‚
â”‚  â”‚    redirect to /order-success                            â”‚
â”‚  â”‚  }                                                        â”‚
â”‚  â”‚                                                           â”‚
â”‚  â””â”€ [COMPLETE]                                              â”‚
â”‚    User receives M-Pesa prompt                              â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Logging Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #1: Backend Startup                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: app.listen() callback                            â”‚
â”‚  When: Backend starts                                       â”‚
â”‚  Output:                                                     â”‚
â”‚  ğŸš€ ===============================================           â”‚
â”‚  âœ… BACKEND SERVER RUNNING ON PORT 3001                    â”‚
â”‚  ğŸš€ ===============================================           â”‚
â”‚  Lipana Status: âœ… Configured                              â”‚
â”‚  Purpose: Confirm backend is running                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #2: Request Received                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1001)        â”‚
â”‚  When: Frontend request arrives                             â”‚
â”‚  Output:                                                     â”‚
â”‚  âœ… LIPANA REQUEST RECEIVED                                â”‚
â”‚  Purpose: Confirm frontend is connected                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #3: Request Details                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (lines 1002-1004)  â”‚
â”‚  When: Request is being processed                           â”‚
â”‚  Output:                                                     â”‚
â”‚  ğŸ“± Phone: 254712345678                                    â”‚
â”‚  ğŸ’° Amount: 100                                            â”‚
â”‚  ğŸ“¦ Order ID: order-xyz                                    â”‚
â”‚  Purpose: See what data was received                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #4: API Call Initiated                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1033)        â”‚
â”‚  When: About to call Lipana                                 â”‚
â”‚  Output:                                                     â”‚
â”‚  ğŸ“¤ Calling Lipana API with phone: +254712345678           â”‚
â”‚  Purpose: Confirm Lipana is being called                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #5: Response Status                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1045)        â”‚
â”‚  When: Lipana responds                                      â”‚
â”‚  Output:                                                     â”‚
â”‚  ğŸ“¥ Lipana response status: 200 OK                         â”‚
â”‚  Purpose: Confirm Lipana responded successfully            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #6: Response Data                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1048)        â”‚
â”‚  When: Parsing Lipana response                              â”‚
â”‚  Output:                                                     â”‚
â”‚  ğŸ“‹ Lipana response data: {                                â”‚
â”‚    "success": true,                                         â”‚
â”‚    "data": {                                                â”‚
â”‚      "transactionId": "123456789",                         â”‚
â”‚      "checkoutRequestID": "ws_CO_...",                    â”‚
â”‚      "message": "STK push initiated successfully"          â”‚
â”‚    }                                                         â”‚
â”‚  }                                                           â”‚
â”‚  Purpose: See complete Lipana response                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #7: Success                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1050)        â”‚
â”‚  When: Payment initiated successfully                       â”‚
â”‚  Output:                                                     â”‚
â”‚  âœ… STK Push successful! Transaction ID: 123456789         â”‚
â”‚  Purpose: Confirm successful payment initiation            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LOGGING CHECKPOINT #8: Error                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Location: /api/lipana/initiate-stk-push (line 1054)        â”‚
â”‚  When: Payment fails                                        â”‚
â”‚  Output:                                                     â”‚
â”‚  âŒ Lipana API returned error: Invalid phone format        â”‚
â”‚  Purpose: See what went wrong                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete Data Transformation

```
Frontend Sends:                 Backend Receives:
{                               {
  phone: "0712345678"    â†’        phone: "0712345678"
  amount: "100"                   amount: "100"
  orderId: "order-123"            orderId: "order-123"
}                               }
                                     â†“
                                Backend Formats:
                                {
                                  phone: "+254712345678"  [formatted]
                                  amount: 100             [parsed to int]
                                  orderId: "order-123"
                                }
                                     â†“
                                Lipana Receives:
                                {
                                  phone: "+254712345678"
                                  amount: 100
                                }
                                     â†“
                                Lipana Responds:
                                {
                                  success: true
                                  data: {
                                    transactionId: "123456789"
                                    checkoutRequestID: "ws_CO_..."
                                    message: "STK push initiated"
                                  }
                                }
                                     â†“
                                Backend Forwards:
                                {
                                  success: true
                                  transactionId: "123456789"
                                  checkoutRequestID: "ws_CO_..."
                                  message: "STK push initiated"
                                  orderId: "order-123"
                                }
                                     â†“
Frontend Receives:
{
  success: true
  transactionId: "123456789"
  checkoutRequestID: "ws_CO_..."
  message: "STK push initiated"
  orderId: "order-123"
}
    â†“
Shows success toast
Redirects to /order-success
```

---

## ğŸ“ Key Locations

| Component | File | Lines | Purpose |
|-----------|------|-------|---------|
| React Checkout | `src/pages/CheckoutPage.jsx` | ~110 | User interface |
| Payment Service | `src/services/payment/mpesaService.js` | ~25 | API call handling |
| Backend Endpoint | `backend/server.js` | 990-1070 | Payment processing |
| Startup Log | `backend/server.js` | 1074-1084 | Backend startup |
| Request Log | `backend/server.js` | 1001-1004 | Request details |
| Lipana Call | `backend/server.js` | 1033 | Lipana API call |
| Response Log | `backend/server.js` | 1045 | Response status |
| Success Log | `backend/server.js` | 1050 | Success message |

---

## ğŸ¯ Port Routing

```
Browser:3000     â†’    Backend:3001     â†’    Lipana API
  â†“                      â†“                     â†“
React App              Express Server      https://api.lipana.dev
Checkout Page         /api/lipana/...      /transactions/push-stk
Sends Request         Proxies Request      Returns Response
Receives Response     Forwards Response
```

---

**Architecture Complete**: All logging integrated into payment flow
