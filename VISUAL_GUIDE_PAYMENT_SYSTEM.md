# ğŸ¨ Payment Response System - Visual Guide

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           COMPLETE PAYMENT FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER INTERFACE LAYER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Checkout Page   â”‚ â† User fills form, selects M-Pesa, clicks "Place Order"
â”‚  - Phone         â”‚
â”‚  - Amount        â”‚
â”‚  - Shipping Info â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CheckoutPage.jsx                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ Validates form data                                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ Creates order in Firestore                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Calls backend payment endpoint                                  â”‚   â”‚
â”‚  â”‚  â””â”€ Receives response                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”œâ”€ Response: { success: true, transactionData: {...} }            â”‚
â”‚           â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Frontend Response Handler                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ Checks response.success                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Updates order in Firestore                                       â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ transactionId                                                â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ paymentStatus: "initiated"/"failed"                         â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ transactionData: { full object }                            â”‚   â”‚
â”‚  â”‚  â””â”€ Redirects to OrderSuccessPage                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â†“                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  OrderSuccessPage.jsx                                               â”‚   â”‚
â”‚  â”‚  Displays based on paymentStatus:                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  âœ… If SUCCESS:          â³ If PENDING:      âŒ If FAILED:         â”‚   â”‚
â”‚  â”‚  â”œâ”€ Order confirmed      â”œâ”€ 5-min timer     â”œâ”€ Error message      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Transaction ID       â”œâ”€ Phone shown     â”œâ”€ Recovery options   â”‚   â”‚
â”‚  â”‚  â”œâ”€ View orders btn      â”œâ”€ Amount shown    â”œâ”€ Retry button       â”‚   â”‚
â”‚  â”‚  â””â”€ Continue shopping    â”œâ”€ Instructions    â””â”€ Alt payment btn    â”‚   â”‚
â”‚  â”‚     btn                  â”œâ”€ Retry btn                             â”‚   â”‚
â”‚  â”‚                          â””â”€ Alt payment btn                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                                          â”‚
         â”‚                    API Call                             â”‚
         â”‚                  POST Request                           â†“
         â”‚              /api/lipana/initiate-stk-push              â”‚
         â”‚                                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BACKEND (Express.js)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST /api/lipana/initiate-stk-push                               â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  Request:                                                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ phone: "0759965800"                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€ amount: 2700                                                 â”‚   â”‚
â”‚  â”‚  â””â”€ orderId: "order-xyz"                                         â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚  Processing:                                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Validate phone format âœ“                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Validate amount range âœ“                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Get Lipana API key âœ“                                         â”‚   â”‚
â”‚  â”‚  â””â”€ Format phone to +254 format âœ“                                â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                               â”‚
â”‚           â†“                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Call Lipana API                                                    â”‚   â”‚
â”‚  â”‚  POST https://api.lipana.dev/v1/transactions/push-stk              â”‚   â”‚
â”‚  â”‚  Headers: x-api-key: [LIPANA_SECRET_KEY]                           â”‚   â”‚
â”‚  â”‚  Body: { phone: "+254759965800", amount: 2700 }                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                            â”‚                                  â”‚
â”‚           â”‚                            â†“                                  â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚           â”‚                   â”‚  Lipana API     â”‚                        â”‚
â”‚           â”‚                   â”‚  - Validates    â”‚                        â”‚
â”‚           â”‚                   â”‚  - Generates ID â”‚                        â”‚
â”‚           â”‚                   â”‚  - Sends STK    â”‚                        â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                            â”‚                                  â”‚
â”‚           â”‚         Response returned  â”‚                                  â”‚
â”‚           â”‚         200 OK / 4xx / 5xx â”‚                                  â”‚
â”‚           â”‚                            â†“                                  â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚           â”‚                   â”‚ SUCCESS (200 OK):                   â”‚    â”‚
â”‚           â”‚                   â”‚ {                                   â”‚    â”‚
â”‚           â”‚                   â”‚   success: true,                    â”‚    â”‚
â”‚           â”‚                   â”‚   data: {                           â”‚    â”‚
â”‚           â”‚                   â”‚     transactionId: "LPN_...",      â”‚    â”‚
â”‚           â”‚                   â”‚     checkoutRequestID: "ws_CO_..."â”‚    â”‚
â”‚           â”‚                   â”‚   }                                 â”‚    â”‚
â”‚           â”‚                   â”‚ }                                   â”‚    â”‚
â”‚           â”‚                   â”‚                                     â”‚    â”‚
â”‚           â”‚                   â”‚ ERROR (4xx/5xx):                    â”‚    â”‚
â”‚           â”‚                   â”‚ {                                   â”‚    â”‚
â”‚           â”‚                   â”‚   success: false,                   â”‚    â”‚
â”‚           â”‚                   â”‚   message: "Error reason"          â”‚    â”‚
â”‚           â”‚                   â”‚ }                                   â”‚    â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                            â”‚                                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                            â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Backend Response Handler                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check Lipana response status                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ If success:                                                    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Build comprehensive response with transaction details      â”‚  â”‚
â”‚  â”‚  â””â”€ If error:                                                      â”‚  â”‚
â”‚  â”‚     â””â”€ Build error response with recovery options                 â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  Response to frontend:                                             â”‚  â”‚
â”‚  â”‚  {                                                                 â”‚  â”‚
â”‚  â”‚    success: true/false,                                            â”‚  â”‚
â”‚  â”‚    transactionId: "...",                                           â”‚  â”‚
â”‚  â”‚    checkoutRequestID: "...",                                       â”‚  â”‚
â”‚  â”‚    transaction: {...},                                             â”‚  â”‚
â”‚  â”‚    instructions: "...",                                            â”‚  â”‚
â”‚  â”‚    recoveryOptions: [...]                                          â”‚  â”‚
â”‚  â”‚  }                                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                                        â”‚
         â”‚          Response received                            â”‚
         â”‚        { success, transaction,... }                   â”‚
         â”‚                                                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATABASE (Firestore)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Order Document Updated                                         â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  On Success:                On Failure:                         â”‚   â”‚
â”‚  â”‚  {                          {                                   â”‚   â”‚
â”‚  â”‚    paymentStatus: "ini.."   paymentStatus: "failed",           â”‚   â”‚
â”‚  â”‚    transactionId: "...",    paymentError: "error msg",         â”‚   â”‚
â”‚  â”‚    transactionData: {       status: "payment_failed"          â”‚   â”‚
â”‚  â”‚      ...complete...         }                                  â”‚   â”‚
â”‚  â”‚    },                                                           â”‚   â”‚
â”‚  â”‚    status: "processing"     On Timeout:                        â”‚   â”‚
â”‚  â”‚  }                          {                                   â”‚   â”‚
â”‚  â”‚                              paymentStatus: "expired",         â”‚   â”‚
â”‚  â”‚                              status: "payment_expired"         â”‚   â”‚
â”‚  â”‚                             }                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey Map

```
START: Checkout Page
   â†“
[User fills shipping]
   â†“
[User selects M-Pesa]
   â†“
[User clicks "Place Order"]
   â†“
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                 â”‚
   â†“ PAYMENT INITIATED                              â”‚
   â”‚                                                 â”‚
   â”œâ”€ Backend validates data                        â”‚ Backend Processing
   â”œâ”€ Calls Lipana API                             â”‚ (behind the scenes)
   â”œâ”€ Receives response                            â”‚
   â”œâ”€ Sends to frontend                            â”‚
   â”‚                                                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                  â”‚                  â”‚                  â”‚
   â†“                  â†“                  â†“                  â†“
SUCCESS          FAILURE            TIMEOUT            EXPIRED
   â”‚                  â”‚                  â”‚                  â”‚
   â”œâ”€ Order shows    â”œâ”€ Shows error    â”œâ”€ Starts         â”œâ”€ Timer
   â”‚  âœ… Completed   â”‚  âŒ Failed      â”‚  5-min timer    â”‚  reaches 0
   â”‚                 â”‚                  â”‚                  â”‚
   â”œâ”€ View orders   â”œâ”€ Recovery        â”œâ”€ User enters    â”œâ”€ Shows
   â”‚  Continue       â”‚  options:        â”‚  M-Pesa PIN     â”‚  "Expired"
   â”‚  shopping       â”‚  - Retry         â”‚                  â”‚
   â”‚                 â”‚  - Alternative   â”œâ”€ If completes:  â”œâ”€ Options:
   â”‚                 â”‚    method        â”‚  âœ… Completed   â”‚  - Retry
   â”‚                 â”‚                  â”‚                  â”‚  - Alternative
   â”‚                 â””â”€ Redirects       â””â”€ Firestore      â”‚    method
   â”‚                   to error page      updates         â”‚
   â”‚                                      âœ… SUCCESS      â””â”€ Redirects
   â”‚                                                       to timeout
   â”‚                                                       page
   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ END

Payment completion handled at each junction.
User always knows what's happening and next steps.
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Input   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Frontend Validation               â”‚
    â”‚ â€¢ Phone format check             â”‚
    â”‚ â€¢ Amount range check             â”‚
    â”‚ â€¢ Required fields check          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ Valid
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Order in Firestore        â”‚
    â”‚ status: "payment_pending"        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Send to Backend Payment Endpoint  â”‚
    â”‚ POST /api/lipana/initiate-stk... â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Backend Validation                â”‚
    â”‚ â€¢ Phone format                   â”‚
    â”‚ â€¢ Amount range                   â”‚
    â”‚ â€¢ API key exists                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ Valid
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Call Lipana API                  â”‚
    â”‚ POST /transactions/push-stk      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
         â†“                 â†“                 â†“
      SUCCESS           4xx ERROR         5xx ERROR
         â”‚                 â”‚                 â”‚
         â”œâ”€ Parse response â”œâ”€ Parse error  â”œâ”€ Catch error
         â”‚ Extract ID      â”‚ Message       â”‚ Generic message
         â”‚                 â”‚               â”‚
         â”œâ”€ Build response â”œâ”€ Build error  â”œâ”€ Build error
         â”‚ with details    â”‚ with recovery â”‚ with recovery
         â”‚                 â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                â”‚
                  â†“                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Send Response to Frontend           â”‚
         â”‚ {success: T/F, transaction, ...}    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                            â”‚
         â†“ SUCCESS                                    â†“ FAILED
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update Firestore:    â”‚              â”‚ Update Firestore:    â”‚
    â”‚ âœ“ transactionId      â”‚              â”‚ âœ“ paymentError       â”‚
    â”‚ âœ“ paymentStatus      â”‚              â”‚ âœ“ paymentStatus      â”‚
    â”‚ âœ“ transactionData    â”‚              â”‚ âœ“ status             â”‚
    â”‚ âœ“ status             â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
         â”‚                                          â”‚
         â†“                                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Navigate to:         â”‚              â”‚ Navigate to:         â”‚
    â”‚ /order-success       â”‚              â”‚ /order-success       â”‚
    â”‚ with state data      â”‚              â”‚ with error state     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                          â”‚
         â†“                                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OrderSuccessPage:    â”‚              â”‚ OrderSuccessPage:    â”‚
    â”‚ Render SUCCESS UI    â”‚              â”‚ Render ERROR UI      â”‚
    â”‚ - Confirmation       â”‚              â”‚ - Error message      â”‚
    â”‚ - Transaction info   â”‚              â”‚ - Recovery options   â”‚
    â”‚ - Next steps         â”‚              â”‚ - Retry button       â”‚
    â”‚ - Timer (if pending) â”‚              â”‚ - Alternative method â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                          â”‚
         â†“ (User continues)                        â†“ (User acts)
    âœ… Order Complete               âŒ Ready for Retry/Alternative
```

---

## Status Transitions

```
Order Created
"payment_pending"
     â”‚
     â†“
[User clicks "Place Order"]
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                            â”‚
     â†“ Success Response                           â†“ Error Response
     â”‚                                            â”‚
"payment_processing"                      "payment_failed"
     â”‚                                            â”‚
     â”œâ”€ 5-min timer starts                        â”œâ”€ User sees error
     â”œâ”€ User enters M-Pesa PIN                    â”œâ”€ Options:
     â”‚                                            â”‚  - Retry
     â”‚  â”œâ”€ Within 5 min âœ“                        â”‚  - Alternative
     â”‚  â”‚  âœ… "payment_completed"                â””â”€ Retry creates
     â”‚  â”‚     (Auto-confirmed)                      new transaction
     â”‚  â”‚
     â”‚  â””â”€ After 5 min âœ—
     â”‚     âš ï¸ "payment_expired"
     â”‚     â”œâ”€ User can retry
     â”‚     â””â”€ New transaction created
     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Order Complete
```

---

## Component Interaction

```
App.jsx
  â”‚
  â”œâ”€ Route: /checkout
  â”‚  â””â”€ CheckoutPage.jsx
  â”‚     â”œâ”€ Validates form
  â”‚     â”œâ”€ Calls createOrder()
  â”‚     â”œâ”€ Calls initiateMpesaPayment()
  â”‚     â”œâ”€ Receives response
  â”‚     â”œâ”€ Updates order status
  â”‚     â””â”€ Navigates to /order-success
  â”‚
  â”œâ”€ Route: /order-success
  â”‚  â””â”€ OrderSuccessPage.jsx
  â”‚     â”œâ”€ Gets order from Firestore
  â”‚     â”œâ”€ Fetches transactionData
  â”‚     â”œâ”€ Renders based on paymentStatus
  â”‚     â”œâ”€ Shows 5-min timer (if pending)
  â”‚     â”œâ”€ Handles retry (calls checkout again)
  â”‚     â””â”€ Handles alternative payment (navigates back to checkout)
  â”‚
  â””â”€ Services Used:
     â”œâ”€ mpesaService.js
     â”‚  â””â”€ initiateMpesaPayment() â†’ Backend POST
     â”œâ”€ firestoreHelpers.js
     â”‚  â”œâ”€ createOrder()
     â”‚  â”œâ”€ getOrder()
     â”‚  â””â”€ updateOrderStatus()
     â””â”€ emailAutomation.js
        â””â”€ sendOrderConfirmation()
```

This visual guide shows exactly how the payment response system flows from user input through backend processing to database storage and UI display! ğŸ¨
